name: generate-hashed-reqs

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR to run the workflow on'
        required: true

jobs:
  comment-workflow-started:
    runs-on: ubuntu-latest
    steps:
    - name: Comment on PR
      uses: snap-research/gigl/.github/actions/comment-on-pr@main
      with:
        pr_number: ${{ inputs.pr_number }}
        message: |
          [BOT] Starting to build base images for CUDA and CPU.
          This may take a while, please be patient.
          The images will be pushed to the GCP Artifact Registry.
          One done, the workflow will update the `dep_vars.env` file with the new image names.

  compute-linux-hashed-requirements:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Check out the repository code.
      - uses: actions/checkout@v3
      # Step 2: Check out the repository code and set up the Python environment.
      - uses: snap-research/gigl/.github/actions/setup-python-tools 
      # Step 3: Generate a hashed requirements file from pyproject.toml using pip-compile.
      - name: Generate all hashed requirements for Linux Platform
        uses: snap-research/gigl/.github/actions/run-command-on-pr@main
        with:
          pr_number: ${{ inputs.pr_number }}
          should_leave_progress_comments: "false"
          command: |
            make -j4 generate_dev_linux_cuda_hashed_requirements \
              generate_linux_cuda_hashed_requirements \
              generate_dev_linux_cpu_hashed_requirements \
              generate_linux_cpu_hashed_requirements
      # Step 4: Upload the computed hashed requirements file as an artifact.
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux_requirements
          path: |
            requirements/linux_cuda_requirements_unified.txt
            requirements/dev_linux_cuda_requirements_unified.txt
            requirements/linux_cpu_requirements_unified.txt
            requirements/dev_linux_cpu_requirements_unified.txt

  compute-mac-hashed-requirements:
    runs-on: macos-14 # macOS-based runner (macOS 14) - Arm64 (Apple Silicon) runner.
    steps:
      - uses: actions/checkout@v3
      - uses: snap-research/gigl/.github/actions/setup-python-tools 
      - name: Generate hashed requirements for MACOS (Silicon) platform
        uses: snap-research/gigl/.github/actions/run-command-on-pr@main
        with:
          pr_number: ${{ inputs.pr_number }}
          should_leave_progress_comments: "false"
          command: |
            make -j2 generate_mac_arm64_cpu_hashed_requirements \
              generate_dev_mac_arm64_cpu_hashed_requirements
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac_requirements
          path: |
            requirements/darwin_arm64_requirements_unified.txt
            requirements/dev_darwin_arm64_requirements_unified.txt

  commit-hashed-requirements:
    needs: 
      - compute-linux-hashed-requirements
      - compute-mac-hashed-requirements
    runs-on: ubuntu-latest
    steps:
      - name: Checkout branch
        uses: snap-research/gigl/.github/actions/checkout-pr-branch@main
        with:
          pr_number: ${{ inputs.pr_number }}
      - name: Download generated linux requirements artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux_requirements
          path: requirements/
      - name: Download generated mac requirements artifacts
        uses: actions/download-artifact@v4
        with:
          name: mac_requirements
          path: requirements/
      # # Ensure that requirements files do not contain `torch` as a listed dependency. This may cause various issues.
      # # Some packages like PyG require a prior installation of torch to install, thus having it listed as a dep
      # # might result in issues - even seg faults if the version installed != one that pyg or dgl expect.
      # - name: Remove torch dependency using Python
      #   run: python .github/scripts/remove_torch_hashed_deps.py
      - name: Commit and Push Hashed Requirement updates
        uses: snap-research/gigl/.github/actions/commit-and-push
        with:
          commit_message: "[AUTOMATED] Update all hashed requirements files"
          github_token: ${{ secrets.GITHUB_TOKEN }}
